generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  JOBSEEKER
  RECRUITER
  ADMIN
}

enum JobStatus {
  OPEN
  CLOSED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum PaymentMethod {
  CASH
  CARD
}

enum PaymentStatus {
  INITIATED
  HELD_IN_ESCROW
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum TransactionType {
  DEBIT
  CREDIT
  PLATFORM_FEE
  ESCROW_HOLD
  ESCROW_RELEASE
  REFUND
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum NotificationType {
  MESSAGE_RECEIVED
  APPLICATION_STATUS_CHANGED
  PAYMENT_RECEIVED
}

enum DisputeStatus {
  OPEN
  RESOLVED_IN_FAVOR_OF_PAYER
  RESOLVED_IN_FAVOR_OF_RECEIVER
}

enum PlanType {
  FREE
  PREMIUM
  ENTERPRISE
}

//////////////////////////////////////////////////////
// CORE USER SYSTEM
//////////////////////////////////////////////////////

model User {
  id                       Int       @id @default(autoincrement())
  name                     String
  email                    String    @unique
  password                 String
  role                     Role
  isEmailVerified          Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?
  isBanned                 Boolean   @default(false)
  isDeleted                Boolean   @default(false)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  profile          Profile?
  company          Company?
  wallet           Wallet?
  applications     Application[]
  messages         Message[]
  refreshTokens    RefreshToken[]
  paymentsMade     Payment[]        @relation("Payer")
  paymentsReceived Payment[]        @relation("Receiver")
  payoutRequests   PayoutRequest[]
  auditLogs        AuditLog[]       @relation("AdminLogs")
  transactionLogs  TransactionLog[]
  notifications    Notification[]
  reviewsGiven     Review[]         @relation("ReviewsGiven")
  reviewsReceived  Review[]         @relation("ReviewsReceived")
  disputesRaised   Dispute[]
  subscription     Subscription?
  jobViews         JobView[]

  @@index([role])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// PROFILE
//////////////////////////////////////////////////////

model Profile {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  bio       String?
  skills    String?
  resumeUrl String?
  location  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// COMPANY
//////////////////////////////////////////////////////

model Company {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  ownerId     Int      @unique
  isVerified  Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())

  owner User  @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  jobs  Job[]
}

//////////////////////////////////////////////////////
// JOB
//////////////////////////////////////////////////////

model Job {
  id           Int       @id @default(autoincrement())
  title        String
  description  String
  salary       Decimal?
  location     String?
  category     String?
  jobType      String?
  status       JobStatus @default(OPEN)
  companyId    Int
  isDeleted    Boolean   @default(false)
  currencyCode String    @default("USD")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  applications Application[]
  jobSkills    JobSkill[]
  views        JobView[]

  @@index([companyId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// APPLICATION
//////////////////////////////////////////////////////

model Application {
  id        Int               @id @default(autoincrement())
  userId    Int
  jobId     Int
  status    ApplicationStatus @default(PENDING)
  appliedAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  job      Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  messages Message[]
  payment  Payment?
  reviews  Review[]

  @@index([userId])
  @@index([jobId])
}

//////////////////////////////////////////////////////
// CHAT
//////////////////////////////////////////////////////

model Message {
  id            Int      @id @default(autoincrement())
  content       String
  senderId      Int
  applicationId Int
  createdAt     DateTime @default(now())

  sender      User        @relation(fields: [senderId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// WALLET
//////////////////////////////////////////////////////

model Wallet {
  id           Int      @id @default(autoincrement())
  userId       Int      @unique
  balance      Decimal  @default(0)
  currencyCode String   @default("USD")
  isFrozen     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// PAYMENT (ESCROW + PAYHERE READY)
//////////////////////////////////////////////////////

model Payment {
  id                Int           @id @default(autoincrement())
  applicationId     Int           @unique
  payerId           Int
  receiverId        Int
  amount            Decimal
  platformFee       Decimal
  netAmount         Decimal
  currencyCode      String        @default("USD")
  paymentMethod     PaymentMethod
  paymentStatus     PaymentStatus @default(INITIATED)
  gatewayProvider   String?
  merchantReference String?
  gatewayReference  String?
  gatewayStatus     String?
  hashSignature     String?
  escrowReleaseAt   DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  application  Application      @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  payer        User             @relation("Payer", fields: [payerId], references: [id], onDelete: Cascade)
  receiver     User             @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  transactions TransactionLog[]
  dispute      Dispute?

  @@index([applicationId])
  @@index([paymentStatus])
}

//////////////////////////////////////////////////////
// TRANSACTION LEDGER
//////////////////////////////////////////////////////

model TransactionLog {
  id          Int             @id @default(autoincrement())
  paymentId   Int
  userId      Int
  type        TransactionType
  amount      Decimal
  description String?
  createdAt   DateTime        @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([paymentId])
}

//////////////////////////////////////////////////////
// PAYOUT REQUEST
//////////////////////////////////////////////////////

model PayoutRequest {
  id          Int          @id @default(autoincrement())
  userId      Int
  amount      Decimal
  status      PayoutStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  processedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// SECURITY
//////////////////////////////////////////////////////

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// ADMIN AUDIT LOG
//////////////////////////////////////////////////////

model AuditLog {
  id              Int      @id @default(autoincrement())
  adminId         Int
  action          String
  targetUserId    Int?
  targetJobId     Int?
  targetPaymentId Int?
  createdAt       DateTime @default(now())

  admin User @relation("AdminLogs", fields: [adminId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// SKILLS (MANY-TO-MANY)
//////////////////////////////////////////////////////

model Skill {
  id   Int    @id @default(autoincrement())
  name String @unique

  jobSkills JobSkill[]
}

model JobSkill {
  jobId   Int
  skillId Int

  job   Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@id([jobId, skillId])
}

//////////////////////////////////////////////////////
// NOTIFICATION SYSTEM
//////////////////////////////////////////////////////

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  content   String
  isRead    Boolean          @default(false)
  linkId    Int? // Polymorphic ID for the related entity
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
}

//////////////////////////////////////////////////////
// DISPUTE SYSTEM
//////////////////////////////////////////////////////

model Dispute {
  id              Int           @id @default(autoincrement())
  paymentId       Int           @unique
  raisedById      Int
  reason          String
  status          DisputeStatus @default(OPEN)
  resolutionNotes String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  payment  Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  raisedBy User    @relation(fields: [raisedById], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// REVIEW SYSTEM
//////////////////////////////////////////////////////

model Review {
  id            Int      @id @default(autoincrement())
  reviewerId    Int
  targetId      Int
  applicationId Int
  rating        Int // 1-5 scale
  comment       String?
  createdAt     DateTime @default(now())

  reviewer    User        @relation("ReviewsGiven", fields: [reviewerId], references: [id], onDelete: Cascade)
  target      User        @relation("ReviewsReceived", fields: [targetId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([targetId])
}

//////////////////////////////////////////////////////
// ANALYTICS & FTS
//////////////////////////////////////////////////////

model JobView {
  id        Int      @id @default(autoincrement())
  jobId     Int
  viewerIp  String? // Optional, for anonymous tracking
  userId    Int? // Optional, if the viewer is logged in
  createdAt DateTime @default(now())

  job  Job   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// PREMIUM SUBSCRIPTIONS
//////////////////////////////////////////////////////

model Subscription {
  id               Int       @id @default(autoincrement())
  userId           Int       @unique
  planType         PlanType  @default(FREE)
  stripeCustomerId String?
  validUntil       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
